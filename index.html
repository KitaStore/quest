<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kartu Stamp Bulanan — KitaStore</title>

<style>
body {
  font-family: "Poppins", sans-serif;
  background: #fff7fa;
  color: #725b63;
  margin: 0;
  padding: 20px;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  max-width: 420px;
  margin: auto;
}

.title {
  font-size: 24px;
  margin-bottom: 15px;
  text-align: center;
  color: #d86b94;
}

/* GRID */
.stamp-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 20px;
}

.stamp-box {
  width: 80px;
  height: 80px;
  background: #fff0f6;
  border: 2px dashed #e3a6b6;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  font-size: 13px;
}

.stamp-box img.stamp {
  width: 50px;
  opacity: 0;
  transform: scale(0.5);
  transition: 0.25s ease-out;
}

.stamp-box img.pop {
  opacity: 1;
  transform: scale(1.1);
  animation: popAnim 0.25s ease-out;
}

@keyframes popAnim {
  0% { transform: scale(0.3); opacity: 0; }
  80% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); }
}

/* Progress Bar */
.progress-wrap {
  margin-top: 20px;
}

.progress {
  width: 100%;
  height: 20px;
  background: #ffe2ee;
  border-radius: 12px;
  overflow: hidden;
}

.progress-inner {
  width: 0%;
  height: 100%;
  background: #ff9fbe;
  transition: width 0.3s ease;
}

.progress-meta {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
}

.actions {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
}

button {
  padding: 10px 15px;
  border-radius: 10px;
  border: none;
  background: #ff9fbe;
  color: white;
  font-weight: bold;
}

button.warn {
  background: #ff6b6b;
}

footer {
  margin-top: 20px;
  font-size: 12px;
  opacity: 0.6;
}
</style>
</head>

<body>

<div class="card">

  <h2 class="title">Kartu Stamp Bulanan — KitaStore</h2>

  <label>Nama SD:</label>
  <input id="namaSdInput" type="text" style="width:100%;padding:10px;margin-bottom:15px;border-radius:10px;border:1px solid #dfbccc;">

  <div class="stamp-grid" id="stampGrid"></div>

  <div class="progress-wrap">
    <div class="progress-meta">
      <div id="progressText">0 / 12</div>
      <div id="rewardCount">0 rewards active</div>
    </div>

    <div class="progress">
      <div class="progress-inner" id="progressInner"></div>
    </div>

    <div class="rewards" id="rewardsRow"></div>

    <div class="actions">
      <button id="resetBtn" class="warn">Reset</button>
      <button id="helpBtn">Cara Pakai</button>
    </div>
  </div>

  <footer>
    Waktu untuk menentukan bulan berasal dari server agar tidak bisa dimanipulasi. 
    Jika server gagal, digunakan waktu perangkat.
  </footer>
</div>

<script>
const months = [
  "Januari","Februari","Maret","April","Mei","Juni",
  "Juli","Agustus","September","Oktober","November","Desember"
];

let stamps = JSON.parse(localStorage.getItem("stamps") || "{}");

function save() { localStorage.setItem("stamps", JSON.stringify(stamps)); }

function renderGrid() {
  const grid = document.getElementById("stampGrid");
  grid.innerHTML = "";

  months.forEach((m,i)=>{
    const box = document.createElement("div");
    box.className = "stamp-box";
    box.textContent = m;

    const img = document.createElement("img");
    img.src = "stamp.png";  // ganti dengan ikonmu
    img.className = "stamp";

    if (stamps[i]) img.classList.add("pop");
    box.appendChild(img);
    grid.appendChild(box);
  });

  updateProgress();
}

function updateProgress() {
  const count = Object.keys(stamps).length;
  document.getElementById("progressText").textContent = `${count} / 12`;
  document.getElementById("progressInner").style.width = (count/12)*100 + "%";
  document.getElementById("rewardCount").textContent = `${Math.floor(count/3)} rewards active`;
}

async function autoStamp() {
  const q = new URL(location.href).searchParams.get("code");
  if (!q) return;

  try {
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbz1TQcYdcT_aUkS0C6DRRzQyzjMJqF2jl5Qvc_H_mI542o0mJIxENmo3zuVbUMl_8VeHA/exec?code="+q
    );
    const data = await res.json();
    if (!data.valid) {
      alert("QR tidak valid.");
      return;
    }

    const now = new Date();
    const month = now.getMonth();

    if (!stamps[month]) {
      stamps[month] = true;
      save();
      renderGrid();
    }
  } catch(e) { console.log("ERR:", e); }
}

// Nama SD → cookie
const namaSd = document.getElementById("namaSdInput");
namaSd.value = localStorage.getItem("namaSd") || "";
namaSd.addEventListener("input", ()=> localStorage.setItem("namaSd", namaSd.value));

document.getElementById("resetBtn").onclick = () => {
  if (confirm("Reset semua stamp?")) {
    stamps = {};
    save();
    renderGrid();
  }
};

renderGrid();
autoStamp();
</script>

</body>
</html>